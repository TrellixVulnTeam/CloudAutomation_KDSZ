""" Git functions
"""

import os
import getpass
import logging
from lxk_testrunner import LOCATE_CMD, GERRIT, GERRIT_SSH, GERRIT_HTTP
from lxk_testrunner.utils import system

LOGGER = logging.getLogger(__name__)
LOGGER.setLevel(logging.DEBUG)

def check_path():
    """ Return bool if git is in PATH
    """
    in_path = True
    try:
        _ = system.execute([LOCATE_CMD, 'git'])
    except system.CalledProcessError:
        in_path = False

    return in_path

def clone(project_name, protocol, dst):
    """ Git clone using SSH.
    """
    assert isinstance(project_name, str), "must be {type_}".format(type_=str)
    assert isinstance(protocol, str), "must be {type_}".format(type_=str)
    assert os.path.isdir(dst), "{path} does not exist!".format(path=dst)

    success = True

    project_path = os.path.join(dst, project_name)
    LOGGER.debug(project_path)

    url = "{protocol}://{user}@{server}{port}/{project}".format(
        protocol=protocol,
        user=getpass.getuser(),
        server=GERRIT,
        port=GERRIT_SSH if protocol == "ssh" else GERRIT_HTTP,
        project=project_name
    )
    LOGGER.debug(url)

    if not os.path.isdir(project_path):
        LOGGER.info("Cloning %s...", project_name)
        try:
            _ = system.execute([
                'git',
                'clone',
                url,
                project_path
            ])
        except system.CalledProcessError:
            success = False
    else:
        LOGGER.info("%s already exists.", project_name)

    return success
